<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Predicci칩n Modelo</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(120deg,#0f172a,#0b1220);color:#e5e7eb;margin:0}
    .container{max-width:980px;margin:0 auto;padding:24px}
    .card{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:#9ca3af}
    input,textarea,select{background:#0f172a;border:1px solid #1f2937;color:#e5e7eb;border-radius:8px;padding:10px;font-size:14px}
    button{background:#2563eb;border:none;color:white;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#9ca3af;font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:12px}
    .result{white-space:pre-wrap;background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:10px;margin-top:12px}
    .toolbar{display:flex;gap:8px;align-items:center;margin:12px 0}
    .badge{display:inline-block;background:#1f2937;color:#e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Interfaz de Predicci칩n</h1>
      <div class="toolbar">
        <span id="status" class="badge">Cargando modelo...</span>
        <button id="reload">Recargar info</button>
      </div>
      <div class="field">
        <label>Modo de entrada</label>
        <select id="mode">
          <option value="features">Campos por feature</option>
          <option value="json">Array JSON (X)</option>
        </select>
        <span class="muted">La UI detecta autom치ticamente si usar /model-info o /api/model-info.</span>
      </div>
      <div id="featuresForm"></div>
      <div id="jsonInput" class="field" style="display:none">
        <label>Array JSON (ej: [1,2,3,...])</label>
        <textarea id="jsonArea" rows="4"></textarea>
      </div>
      <div class="toolbar">
        <button id="predict">Predecir</button>
      </div>
      <div id="output" class="result"></div>
    </div>
  </div>
  <script>
    const state={base:"",features:[],pathVariant:""};
    const statusEl=document.getElementById('status');
    const reloadBtn=document.getElementById('reload');
    const modeSel=document.getElementById('mode');
    const featuresForm=document.getElementById('featuresForm');
    const jsonWrap=document.getElementById('jsonInput');
    const jsonArea=document.getElementById('jsonArea');
    const predictBtn=document.getElementById('predict');
    const outputEl=document.getElementById('output');

    async function fetchModelInfo(){
      statusEl.textContent='Cargando modelo...';
      const origin=window.location.origin;
      const paths=['/model-info','/api/model-info'];
      for(const p of paths){
        try{
          const res=await fetch(origin+p);
          if(res.ok){
            const data=await res.json();
            state.base=origin;
            state.pathVariant=p.startsWith('/api')?'/api':'';
            state.features=Array.isArray(data.feature_names)?data.feature_names:[];
            statusEl.textContent='Modelo detectado: '+(data.model_type||'N/D');
            renderFeatures();
            return;
          }
        }catch(e){}
      }
      statusEl.textContent='No se pudo cargar el modelo';
      state.features=[];
      renderFeatures();
    }

    function renderFeatures(){
      const mode=modeSel.value;
      if(mode==='features'){
        jsonWrap.style.display='none';
        featuresForm.innerHTML='';
        const wrap=document.createElement('div');
        wrap.className='grid';
        const list=(state.features&&state.features.length)?state.features:[];
        if(list.length===0){
          const info=document.createElement('div');
          info.className='muted';
          info.textContent='Sin feature_names. Usa modo JSON.';
          featuresForm.appendChild(info);
        } else {
          for(const f of list){
            const field=document.createElement('div');
            field.className='field';
            const label=document.createElement('label');
            label.textContent=f;
            const input=document.createElement('input');
            input.type='text';
            input.id='f_'+f;
            field.appendChild(label);
            field.appendChild(input);
            wrap.appendChild(field);
          }
          featuresForm.appendChild(wrap);
        }
      } else {
        featuresForm.innerHTML='';
        jsonWrap.style.display='block';
      }
    }

    modeSel.addEventListener('change',renderFeatures);
    reloadBtn.addEventListener('click',fetchModelInfo);

    predictBtn.addEventListener('click',async()=>{
      outputEl.textContent='';
      const url=state.base+(state.pathVariant||'')+'/predict';
      let payload={};
      if(modeSel.value==='features'){
        const list=(state.features&&state.features.length)?state.features:[];
        const obj={};
        for(const f of list){
          const v=document.getElementById('f_'+f)?.value;
          obj[f]=v!==undefined&&v!==''?Number(v):0;
        }
        payload={features:obj};
      } else {
        try{
          const arr=JSON.parse(jsonArea.value||'[]');
          payload={X:arr};
        }catch(e){
          outputEl.textContent='JSON inv치lido';
          return;
        }
      }
      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const text=await res.text();
        outputEl.textContent=res.ok?text:('Error '+res.status+'\n'+text);
      }catch(e){
        outputEl.textContent='Fallo de red';
      }
    });

    fetchModelInfo();
  </script>
</body>
</html>
